# 串口通信协议
## I2C
### 简介：
> I2C(Inter-Integrated Circuit),也叫集成电路总线，`是一种同步、双向、双线的串口通信协议`，多用于`主控制器和从器件`之间的通信，I2C通信只需要两根线，一根是`数据线SDA`，一根是`时钟线SCL`。
![alt text](https://img2024.cnblogs.com/blog/3066510/202407/3066510-20240708141246455-2086363786.png)
### 硬件层面
> I2C有两条总线，一条双向的串行数据线SDA，一条串行时钟线SCL
- SDA(Serial data):串行数据线，用来传输数据
- SCL(Serial clock line):时钟线，用来控制数据发送的时序。
- 这两根线分别通过上拉电阻连接到电源。

![alt text](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811161015466-1873767395.png)
> 所有接到I2C总线上的设备的SDA线都接到总线的SDA上，各设备的时钟线SCL都接到总线的SCL上。I2C总线上的每一个设备都有一个唯一的地址，以确保不同设备之间的访问互不干扰。

**I2C是多主从架构，每个设备都有唯一的地址，一个主设备理论上可以接127个从设备，设备的SDA并接在一起，SCL并接在一起。**

![!\[alt text\](image-1.png)](https://img2024.cnblogs.com/blog/3066510/202407/3066510-20240708141253215-1884442673.png)

>I2C总线内部都是采用`漏极开路驱动(Open Drain)`,如图，栅极给电压时mos导通，输出低电平，栅级给0时mos关断输出呈高阻态，那么这里就无法输出高电平。

![!\[alt text\](image-3.png)](https://img2024.cnblogs.com/blog/3066510/202407/3066510-20240708141258099-1929206790.png)
>加上上拉电阻后可以实现高低电平的输出：开关断开时电阻趋于无穷，电流为0，电源电压为输出电压，即输出高电平；开关闭合，输出低电平。只要有一个设备拉低总线电平，总线的电平就会被拉低，这就是`线与`功能，便于数据的传输和仲裁。

![!\[alt text\](image-4.png)](https://img2024.cnblogs.com/blog/3066510/202407/3066510-20240708141310253-822669616.png)
### 主从设备功能和职责
#### I2C主设备(master)
- 1.`产生时钟(SCL)`:主设备负责控制SCL线的电平变化，以产生时钟信号。这个时钟信号用于同步主设备和从设备之间的数据传输。在每个周期内，SDA线上的数据状态被稳定地传输，并在SCL的某个边缘被采样。
- 2.`产生起始信号`：通信开始时，主设备通过将SDA线从高电平拉至低电平(同时SCL线为高电平)来产生一个起始信号。这个信号标志着数据传输的开始，并通知所有I2C总线上的设备开始准备接收或发送数据。
- 3.`产生结束信号`：数据传输结束时，主设备通过将SDA线从低电平拉至高电平(同时SCL线为高电平)来产生一个结束信号。这个信号标志着数据传输的结束，并允许总线再次进入空闲状态。
- 4.`发送数据`：主设备负责向从设备发送数据。数据按位发送，从最高位到最低位依次进行。每发送一个字节后，主设备会等待从设备的应答信号(ACK)
- 5.`接收数据`：在某些情况，主设备也会从从设备接收数据。这通常发生在主设备发送了一个读命令给从设备之后。
#### I2C从设备(Slave)
- 1.`可编程的IIC地址检测`：每个从设备都有一个唯一的地址。当主设备在SDA线上发送地址时，从设备会检查这个地址是否与自己的地址相匹配。如果匹配，从设备就会准备接收或发送数据。
- 2.`停止位检测`：从设备会检测SCL和SDA线上的结束信号，以确定数据传输何时结束。当检测到结束信号时，从设备会停止数据传输，并可能进入低功耗模式或待机状态
- 3.`应答信号(ACK)`:在从设备接收到一个字节的数据后，它会通过拉低SDA线(拉低电平)一个时钟周期的时间来发出应答信号(ACK)。这个信号告诉主设备数据已被成功接收，并准备好接收下一个字节的数据。如果没有数据要接收或发生了错误，从设备可能会发出一个非应答信号(NACK)
- 4.`数据发送和接收`：当从设备被寻址时，它会根据主设备的命令发送数据或接收数据。数据的发送和接收都是按位进行的，与主设备的操作类似。
#### 小结
> I2C总线在物理连接上非常简单，分贝由SDA和SCL及上拉电阻组成。`通信原理是通过对SCL和SDA线高低电平时序的控制，来产生I2C总线协议所需要的信号进行数据传输`。在总线空闲状态时，SCL和SDA被上拉电阻Rp拉高，使SDA和SCL线都保持高电平。
### I2C协议层
- `开始信号(Start)`:SCL为高电平时，SDA由高电平向低电平跳变，标志着开始传输数据
- `结束信号(Stop)`:SCL为高电平时，SDA由低电平向高电平转变，标志着结束传输数据
![!\[alt text\](image-5.png)](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811162141116-282349876.png)

- `应答信号(ACK/NACK)`:所有地址和数据都以8bit为单位传输，如果接收端正确接收了8bit数据，则回复一个bit的"0"信号——ACK信号，如果未正确接收8bit数据，或者接收端不再接收数据，则回复一个bit的"1"信号——NACK信号。即每8bit数据，就会跟1bit的ACK/NACK信号。
**tips:** 主设备传输完8bit数据后，会释放SDA线(将其设置为高阻态)，从设备可以拉低SDA线发送ACK，主设备检测应答信号。
![!\[alt text\](image-6.png)](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811162159666-910928588.png)

**ACK信号作用**
- `数据有效性`：IIC信号在传输过程中，当SCL为高电平(SCL=1)时，数据线SDA必须保持稳定状态，不允许有电平跳变。只有当SCL处于低电平期间，SDA的高、低电平才可以交替变化。也就是说发送数据时，bit数据"0"和"1"的交替是发生在SCL低电平期间。(从设备在SCL低电平期间，修改SDA线上的电平，每个数据位的"0"和"1"，来准备下一个要传输的数据)
![!\[alt text\](image-7.png)](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811162211545-982762212.png)

### 数据传输
### I2C写数据
**数据发送格式**

![https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811164912112-445015427.png](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811164912112-445015427.png)

- 1.多数从设备的地址为7位或者10位，一般都用七位。八位设备地址=7位从机地址+读/写地址
- 2.再给地址添加一个方向位，用来表示接下来数据传输的方向：0表示主设备向从设备(write)写数据，1表示主设备向从设备(read)读数据
- 3.I2C的每一帧数据由9bit组成，如果发送数据，则包含8bit数据+1bit ACK；如果是设备地址数据，则8bit包含7bit设备地址 1bit方向位
- 4.在起始信号后必须传送一个从机的地址(7位)1~7位为7位接收器件地址，第8位为读写位，用"0"表示主机发送数据(W)，"1"表示主机接收数据(R)，第9位为ACK应答位，紧接着为第一个数据字节，然后是一位应答位，后面继续第二个数据字节

![!\[alt text\](image-9.png)](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811165038034-985476036.png)

**写数据格式**
![!\[alt text\](image-10.png)](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811162517550-1775873195.png)
![!\[alt text\](image-11.png)](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811165102405-707662052.png)
![!\[alt text\](image-12.png)](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811165110085-152628694.png)
**字段解析**
- Start:数据传输的开始信号，由主设备产生
- Device address:标识从设备的地址，bit7~bit1
- R/W：W为主机向从机写数据，R为主机向从机读数据
- ACK：主机读数据时，从机做接收，由从机产生ACK信号
- Word Address：从设备内部的数据地址，即主机要往从机的这个地址写数据
- Data：发送的数据，以字节为单位，每8bit数据，从设备回一个ACK信号
- Stop:数据传输的结束信号，由主设备产生

**主机向从机写（发送）数据流程：**

- 1.主机首先产生START信号；

- 2.然后紧跟着发送一个从机地址，这个地址共有7位，紧接着的第8位是数据方向位(R/W)，0表示主机发送数据(写)，1表示主机接收数据(读)；

- 3.主机发送地址时，总线上的每个从机都将这7位地址码与自己的地址进行比较，若相同，主机则认为自己正在被主机寻址，根据R/W位将自己确定为发送器和接收器;(注：不要把发送器/接收器同主设备/从设备混淆，当主设备向从设备写数据的时候，主设备做发送器，从设备做接收器；当主设备向从设备读数据的时候，主设备做接收器，从设备做发射器)

- 4.这时候主机等待从机的应答信号(ACK)；

- 5.当主机收到应答信号时，发送要访问从机的哪个地址， 继续等待从机的应答信号；

- 6.当主机收到应答信号时，发送N个字节的数据，继续等待从机的N次应答信号;

- 7.主机产生停止信号，结束传送过程。
### I2C读数据
![!\[alt text\](image-13.png)](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811163713087-1640092915.png)
**I2C读(接收)数据格式**
![!\[alt text\](image-14.png)](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240811165124769-473012051.png)
**字段解析**
- Start:数据传输的开始信号，由主设备产生
- Device address:标识从设备的地址，bit7~bit1
- R/W：W为主机向从机写数据，R为主机向从机读数据
- ACK：正式接收数据后的ACK信号由主机产生。Data传输前的ACK信号由从机产生
- Word Address：从设备内部的数据地址，即主机要往从机的这个地址读数据
- Data：接收的数据，以字节为单位，每8bit数据，从设备回一个ACK信号
- RS：restart信号，表现形式和start信号完全一样，只是在读的过程中，再次触发了依次start信号，所以称之为restart
- NACK：当主机读完指定长度的数据时，会在最后一个byte接收完成后，产生一个NACK信号
- Stop：数据传输的结束信号，由主设备产生

**主机向从机读（接收）数据流程：**
- 主机向从机读数据实际上分了两个步骤，`一是把需要希望从从机的哪个地址（Word Address）读数据，通过“写”（W）的方式告诉从机`；`然后再次发送读（R）信号，这时从机才开始给主机发送信号`。

- 1.主机首先产生START信号；

- 2.然后紧跟着发送一个从机地址，注意此时该地址的R/W位为0，表明是向从机写命令，通知从机，主机要读的地址；

- 3.这时候主机等待从机的应答信号(ACK)；

- 4.当主机收到应答信号时，发送要访问的地址，继续等待从机的应答信号；

- 5.当主机收到应答信号后，主机要改变通信模式(主机将由发送变为接收，从机将由接收变为发送)所以主机重新发送一个开始start信号，然后紧跟着发送一个从机地址，注意此时该地址的R/W位为1，表明将主机设置成接收模式开始读取数据；

- 6.这时候主机等待从机的应答信号，当主机收到应答信号时，就可以接收n个字节的数据，当接收完成后，主机发送非应答信号（NACK），表示不再接收数据；

- 7.主机进而产生停止信号，结束传送过程。

### 数据传输帧格式
> I2C数据的传输也遵循一定的格式。它有开始和停止条件，中间进行8bit的数据传输，没有奇偶校验，并且在一个开始条件和停止条件之间可以传要多少数据由多少数据。注：总线默认保持高电平

![alt text](image-15.png)

### 寄存器
> 控制寄存器控制开始停止条件，每传输完一个字节会进入内部中断，状态寄存器记录单片机的工作状态。作为主机时，分频器寄存器配合内部时钟设置I2C的波特率；地址寄存器是从机地址编址；最后是数据寄存器。

**控制寄存器**
- 控制寄存器用于控制I2C通信的开始和停止条件。开始条件（Start Condition）是通信的起始信号，由主机发送，用于通知从机通信即将开始。停止条件（Stop Condition）是通信的结束信号，也由主机发送，用于通知从机通信结束。

**内部中断**
- 在I2C通信中，每当传输完一个字节的数据后，会触发一个内部中断。这个中断允许单片机（或微控制器）的固件（或软件）在数据传输的关键点介入，执行必要的操作，如准备下一个字节的数据、检查错误状态等。

**状态寄存器**
- 状态寄存器用于记录单片机（或微控制器）在I2C通信过程中的工作状态。这些状态可能包括通信是否正在进行、是否发生错误（如超时、数据冲突等）、以及当前是处于发送还是接收状态等。

**分频器寄存器与波特率**
- 分频器寄存器：当单片机作为I2C主机时，分频器寄存器用于配合内部时钟来设置I2C通信的波特率（或称为位速率）。波特率是指每秒传输的比特数（bps），它决定了数据传输的速度。
波特率：波特率是一个衡量数据传输速率的单位，它表示每秒可以传输多少比特（bit）的数据。在I2C通信中，波特率是通过调整SCL时钟线的频率来控制的。较高的波特率意味着数据传输更快，但也可能导致信号干扰和通信不稳定。因此，选择适当的波特率对于确保通信的可靠性和效率至关重要。

**地址寄存器**
- 地址寄存器用于存储从机的地址。在I2C通信中，每个从设备都有一个唯一的地址（或地址范围），主机通过发送这个地址来指定要与哪个从设备进行通信。

**数据寄存器**
- 数据寄存器用于存储要发送或接收的数据。在发送数据时，主机将数据写入数据寄存器，并通过I2C总线发送给从机。在接收数据时，从机通过I2C总线将数据发送给主机，主机将数据读入数据寄存器。

### I2C协议特点
- 只需要两条总线：串行数据线(SDA)和串行时钟线(SCL)
- 连接到总线的每个设备都是可通过唯一地址进行软件寻址的，并且始终存在简单的控制器/目标关系；控制器可以作为控制器发送器或控制器接收器运行。
- 这是一种真正的多控制器总线，包括冲突检测和仲裁，以防止两个或更多控制器同时启动数据传输时出现数据损坏。
- 支持不同的通信速率(100KHz~400KHz)
- SCL和SDA都需要接上拉电阻 (大小由速度和容性负载决定一般在3.3K-10K之间) 保证数据的稳定性，减少干扰；
- IIC是半双工，而不是全双工，同一时间只可以单向通信
### 高低电平时序控制
#### 高低电平：
> 在数字电路中，电平通常分为高电平和低电平两种状态。高电平一般对应于较高的电压值（如5V或3.3V，取决于单片机或电路的电源），而低电平则对应于较低的电压值（如0V）。这两种电平状态是数字电路中最基本的信号表示方式。
#### 时序
> 时序是指一系列具有时间顺序的事件或信号。在高低电平时序控制中，时序指的是高低电平信号在时间轴上的排列顺序和持续时间。这些信号按照特定的时间顺序和规则变化，以实现电路或系统的预期功能。

## SPI
### 简介：
> SPI(Serial Periptheral Interface)是一种`同步串行通信协议`，用于`微控制器(MCU)和它们的外围设备(外围IC)之间或两个微控制器(MCU)之间的通信`。

![alt text](https://www.analog.com/cn/_/media/images/analog-dialogue/en/volume-52/number-3/articles/introduction-to-spi-interface/205973_fig_01.svg?la=en&rev=f03bda0b77f94822a05ed2e7e8f8070d&sc_lang=zh)
- 通过`单独的数据线`和`单独的时钟信号`来保证发送端和接收端的完美同步。
- SPI通信通常需要四根线：`SCLK(时钟线)、CS/SS(片选线)、MOSI(主设备数据输出线)、MISO(主设备数据输入线)`，通过时钟极性和相位配置实现不同模式的通信。
- 时钟是一个振荡信号，他告诉接收端在确切的时机对数据线上的信号进行采样。`数据的采集时机可能是时钟信号的上升沿(从低到高)或下降沿(从高到低)`，具体看对SPI的配置。
- SPI通信是`全双工`的，意味着它可以同时发送和接收数据。以其`全双工、高速率和简单硬件结构`优于UART
- SPI支持多从机模式，如`多NSS或菊花链连接`，但缺乏硬件级别的错误检查协议，并且通常仅支持一个主设备。

**CS/SS(ChipSelect/Slave Select)和NSS(Not Selected或Slave Select)**
> `用于SPI通信中选择需要通信的从设备`，当有多个从设备与主设备相连时，每个从设备都会有一个独立的CS/SS或NSS引脚连接到主设备上。主设备通过控制这些引脚的电平（通常是拉低为有效）来选择与哪个从设备进行通信。

> 一旦某个从设备的CS/SS或NSS引脚被选中（即被拉低），该从设备就会开始监听SPI总线上的数据，而其他未被选中的从设备则会忽略这些数据。

**菊花链连接** 
> 一种特殊的从设备连接方式，允许`将多个从设备串联起来进行通信`，但通常只支持单向通信，且通信速度可能受限。
### 整体传输过程
- 1.主机先将NSS信号拉低，这样保证开始接收数据
- 2.当接收端检测到时钟的边沿信号时，它将立即读取数据线上的信号，这样就得到了一位数据(1bit)
- 3.主机发送到从机时：主机产生相应的时钟信号，然后数据一位一位地将从MOSI信号线上进行发送到从机
- 4.主机接收从机数据:如果从机需要将数据发送回主机，则主机将继续生成预订数量的时钟信号，并且从机将数据通过MISO信号线发送

如图所示
![alt text](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240821085644272-1692596971.png)

>注意，SPI是“全双工”(具有单独的发送和接收线路)，因此`可以在同一时间发送和接收数据`，另外SPI的接收硬件可以是一个简单的`移位寄存器`。这比异步串行通信所需的完整UART要简单得多，并且更加便宜;
数据在传输中，高位在先还是低位在先，SPI协议并无明确规定，但是数据要在主从机中正确传输，自然双方要先约定好,`一般会采用高位在先(MSB)方式传输`。
图中可能会产生歧义，关于0x53，这里要表达的意思是`右边到左边是字节高位到低位`。

**移位寄存器**
- 移位寄存器是计算机和数字系统中常用的一种寄存器类型，它具有位移功能，可以按位进行数据的左移或右移操作
- 移位寄存器的工作原理是在若干相同时间脉冲下工作，以触发器为基础的器件。数据以并行或串行的方式输入到该器件中，然后每个时间脉冲依次向左或右移动一个比特，在输出端进行输出。在左移模式下，数据从输入端进入最左边的触发器，并随着时钟信号的到达，逐位向左移动；在右移模式下，数据从输入端进入最右边的触发器，并随着时钟信号的到达，逐位向右移动。

**下图显示了单个主机和单个从机之间的典型SPI连接**
![alt text](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240821091944747-1424737870.png)
### 时钟频率
> SPI总线上的主机必须在通信开始时配置并生成相应的时钟信号。在每个SPI时钟周期内，都会发生`全双工数据传输`。

>当只进行单向数据传输时（例如，主设备仅向从设备发送数据而不关心从设备的响应），从设备仍然会按照SPI协议的要求在MISO线上发送数据。然而，在这种情况下，从设备发送的数据对于主设备来说可能是无关紧要的，或者主设备可能根本不需要接收这些数据。这时，从设备发送的数据可以被称为`“虚拟数据”`
> 这是因为SPI通信的同步性质要求发送端和接收端都按照时钟信号的节奏进行工作。如果一方停止发送数据，可能会导致另一方无法正确接收或发送数据，从而破坏通信的同步性。
- 从理论上讲，只要实际可行，时钟速率就可以是您想要的任何速率，但这个速率受限于每个系统能提供多大的系统时钟频率，以及最大的SPI传输速率。

### 时钟极性(CPOL/CLock Polarity)和时钟相位(CPHA)
> SPI协议通过配置`时钟极性（CPOL）和时钟相位（CPHA）`来定义不同的通信模式，以适应不同的硬件设备和通信需求
#### 时钟极性(CPOL)
> 时钟极性决定了SPI总线在空闲状态（即没有数据传输时）时，时钟信号（SCLK）的电平状态。CPOL有两个可能的值：
- `CPOL = 0`：表示SPI总线在空闲状态时，时钟信号的电平为低电平（0）。这意味着，在数据传输开始之前，时钟信号是处于低电平状态的。
- `CPOL = 1`：表示SPI总线在空闲状态时，时钟信号的电平为高电平（1）。这意味着，在数据传输开始之前，时钟信号是处于高电平状态的
#### 时钟相位(CPHA)
> 时钟相位决定了数据是在时钟信号的哪个边沿（上升沿或下降沿）被采样或发送。CPHA也有两个可能的值：
- `CPHA = 0`：表示数据在时钟信号的第一个边沿（上升沿或下降沿，取决于CPOL的值）被采样或发送。具体来说，如果CPOL=0，则数据在时钟信号的上升沿被采样或发送；如果CPOL=1，则数据在时钟信号的下降沿被采样或发送。
- `CPHA = 1`：表示数据在时钟信号的第二个边沿（与第一个边沿相反）被采样或发送。具体来说，如果CPOL=0，则数据在时钟信号的下降沿被采样或发送；如果CPOL=1，则数据在时钟信号的上升沿被采样或发送。
#### 不同通信模式
结合时钟极性和时钟相位的配置，SPI协议定义了四种不同的通信模式（Mode 0、Mode 1、Mode 2、Mode 3）：
|模式|CPOL|CPHA|描述|
| --- |---| --- |---|
|Mode 0|0|0|空闲时SCLK为低电平，数据在SCLK的上升沿采样，在下降沿发送。|
|Mode 1|0|1|空闲时SCLK为低电平，数据在SCLK的下降沿采样，在上升沿发送。|
|Mode 2|1|0|空闲时SCLK为高电平，数据在SCLK的下降沿采样，在上升沿发送。|
|Mode 3|1|1|	空闲时SCLK为高电平，数据在SCLK的上升沿采样，在下降沿发送。|
> 综上几种情况，下图总结了所有时钟配置组合，并突出显示了实际采样数据的时刻;
其中黑色线为采样数据的时刻；
蓝色线为SCK时钟信号；
![https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240821094516559-1700238121.png](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240821094516559-1700238121.png)
### 多从机模式
>SPI总线必须有一个主机，可以有多个从机，那么具体连接到SPI总线的方法有两种：
#### 1.多NSS
- 1.通常，每个从机都需要一条单独的NSS线
- 2.如果要和特定的从机进行通信，可以将相应的NSS信号线拉低，并保持其他NSS信号线的状态为高电平；如果同时将两个NSS信号线拉低，则可能会出现乱码，因为从机可能都试图在同一条MISO线上传输数据，最终导致接收数据乱码。

![alt text](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240821095722993-679384385.png)
#### 2.菊花链
> 在数字通信世界中，在设备信号(总线信号或中断信号)以串行的方式从一个设备依次传到下一个设备，不断循环直到数据到达目标设备的方式被称为`菊花链`。
- 1.菊花链的最大缺点是信号串行传输，所以一旦数据链路中的设备发生故障，他下面优先级较低的设备就不可能得到服务了
- 2.另一方面，距离主机越远的从机，获得服务的优先级越低，所以需要安排好从机的优先级，并且设置总线检测器，如果某个从机超时，则对该从机进行短路，防止单个从机损坏造成整个链路崩溃的情况
![alt text](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240821100207319-550505676.png)

### SPI通信的优缺点
#### 优势
- 全双工串行通信
- 高速数据传输速率
- 简单的软件配置
- 极其灵活的数据传输，不限于8位，可以是任意大小的字
- 非常简单的硬件结构，从站不需要唯一地址(与12C不同)。从机使用主机时钟，不需要精密时钟振荡器/晶振(与UART不同)。不需要收发器(与CAN不同)。
#### 缺点
- 没有硬件从机应答信号(主机可能在不知情的情况下无处发送)；
- 通常仅支持一个主设备;
- 需要更多的引脚(与12C不同);
- 没有定义硬件级别的错误检查协议;
- 与RS-232和CAN总线相比，只能支持非常短的距离；
### SPI通信的主要特点
- 全双工通信：可以同时发送和接收数据。
- 高速数据传输：比I2C等其他串行通信协议快，通常能达到甚至超过10M/bps。
- 主从模式：有一个主设备（Master）和多个从设备（Slave）。
- 同步通信：使用时钟信号（SCLK）来同步数据传输。
- 数据帧格式：通常为8位或16位，可以配置为MSB（高位在前）或LSB（低位在前）。
- 连接简单：只需要4根线：SCLK、MOSI（主设备数据输出，从设备数据输入线）、MISO（主设备数据输入，从设备数据输出线）、CS（片选信号线）

## UART
### 简介
> UART(Universal Asynchronous Receiver/Transmitter,通用异步接收器/发送器)，是异步串口通信协议的一种，工作原理是将传输数据的每个字节一位接一位地传输，它能将要传输的数据在串行通信和并行通信之间加以转换，能够灵活地与外部设备进行全双工数据交换
#### 基本特性
- 异步通信：UART不使用时钟信号来同步数据，而是依赖于数据包中的起始位和停止位来标识数据帧的开始和结束。
![alt text](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240818132928627-1544304958.jpg)
- 全双工通信：UART可以同时发送和接收数据，即全双工模式

![https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240818133145064-1217683451.png](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240818133145064-1217683451.png)
- 简单的物理连接：通常只需要两根线(TX和RX)，分别用于发送和接收数据
![alt text](https://img2024.cnblogs.com/blog/3066510/202408/3066510-20240818133154173-1926109001.jpg)
### 数据传输
![alt text](https://img2018.cnblogs.com/blog/1545553/201905/1545553-20190503191826863-1694313472.png)
**1)起始位**
- 数据帧开始前的一个0位，当未有数据发送时，数据线处于逻辑"1"状态；先发出一个逻辑"0"信号，表示开始传输

**2)数据位**
- 紧接着起始位之后，通常是7或8位，8位是最常用的设置

**3)奇偶校验位**
- 可选的额外位，用于错误检测。可以是无校验、偶校验或奇校验

**4)停止位**
- 数据帧之后的一个或两个位，用于标识数据帧的结束。可以是1、1.5或2位

**5)空闲位**
- 处于逻辑"1"状态，表示当前线路上没有数据传输，进入空闲状态
- 处于逻辑"0"状态，表示开始传送下一数据段

**6)波特率**
> 表示每秒钟传送的码元符号的个数，是衡量数据传送速率的指标，它用单位时间内载波调制状态改变的次数来表示。

- 常用的波特率有：9600、115200……

- 时间间隔计算：1秒除以波特率得出的时间，例如，波特率为9600的时间间隔为1s / 9600（波特率） = 104us

**奇偶校验**
- 1.奇校验：当检测数据中“1”的个数为偶数时，奇校验位为“1”；当检测数据中“1”的个数为奇数时，奇校验位为“0”。这样，包括校验位在内的数据中“1”的个数总是奇数。
- 2.偶校验：与奇校验相反，当检测数据中“1”的个数为偶数时，偶校验位为“0”；当检测数据中“1”的个数为奇数时，偶校验位为“1”。这样，包括校验位在内的数据中“1”的个数总是偶数。
### UART的硬件实现

- TX(Transmit)引脚：发送数据到接收设备的引脚
- RX(Receive)引脚：从发送设备接收数据的引脚
- RTS/CTS（Request to Send / Clear to Send）：硬件流控制引脚，用于控制数据的发送和接收。
### 通信过程
- 1.起始位：发送设备将TX线从高电平拉低，开始传输数据帧
- 2.数据位：发送设备按照最低位优先的顺序发送数据位
- 3.奇偶校验位(若启用):发送设备根据数据位的奇偶关系发送奇偶校验位
- 4.停止位：发送设备将TX线拉高，结束数据帧的传输
- 5.空闲状态：在没有数据传输时，TX线保持高电平
### 工作原理
#### 1)发送过程
**a)数据写入发送FIFO**

- 当有数据需要发送时，这些数据首先被写入发送FIFO中。发送FIFO作为一个缓冲区，用于存储待发送的数据。   

**b) UART使能与发送**
- 如果UART被使能（即处于激活状态），它会按照预先设置好的参数（如波特率、数据位、停止位、校验位等）开始从发送FIFO中读取数据并发送。
- 发送过程会一直持续，直到发送FIFO中没有数据为止。

**c)BUSY标志位**
- 一旦有数据被写入发送FIFO（且FIFO未空），UART的忙标志位（BUSY）就会变为有效状态，表示UART正在忙于发送数据。
- BUSY位会在发送FIFO为空，并且已经从移位寄存器发送了最后一个字符（包括停止位）之后才变为无效状态。这意味着即使UART不再被使能，只要发送过程尚未完成，BUSY位就可能保持有效。

#### 2)接收过程
**a)起始位检测**
- UART接收器在空闲时持续监控数据输入。如果数据输入从高电平变为低电平，即接收到了起始位，则接收计数器开始运行。
- 数据在Baud16（即波特率周期的16倍，用于更精确地定位数据位）的第8个周期被采样。如果此时Rx（接收线）仍然为低电平，则起始位被认为是有效的；否则，起始位被视为错误并被忽略。

**b)数据位采样**
- 如果起始位有效，UART会根据数据字符被编程的长度（如5位、6位、7位或8位等），在Baud16的每第16个周期（即一个位周期之后）对连续的数据位进行采样。

**c)奇偶校验位检测**
- 如果奇偶校验模式被使能，UART还会在数据位之后检测奇偶校验位，以确保传输的数据的完整性。

**d)停止位检测**
- 最后，UART会检查Rx是否为高电平以确认有效的停止位。如果Rx为高电平，则一个完整的字符被成功接收；如果Rx不为高电平，则发生帧错误。

**e)数据存储**
- 当接收到一个完整的字符（包括起始位、数据位、校验位和停止位）时，该字符的数据部分（不包括起始位和停止位）会被存放在接收FIFO中，以便后续处理

#### 3)中断控制
出现以下情况时，可使UART产生中断：
- FIFO 溢出错误
- 线中止错误（line-break，即Rx 信号一直为0 的状态，包括校验位和停止位在内）
- 奇偶校验错误
- 帧错误（停止位不为1）
- 接收超时（接收FIFO 已有数据但未满，而后续数据长时间不来）
- 发送
- 接收
>由于所有中断事件在发送到中断控制器之前会一起进行“或运算”操作，所以任意时刻 UART 只能向中断产生一个中断请求。通过查询中断状态函数，软件可以在同一个中断服务函数里处理多个中断事件（多个并列的if 语句）

#### 4)FIFO操作
> FIFO 是“First-In First-Out”的缩写，意为“先进先出”，是一种常见的队列操作。 Stellaris 系列ARM 的UART 模块包含有2 个16 字节的FIFO：一个用于发送，另一个用于接收。可以将两个FIFO 分别配置为以不同深度触发中断。可供选择的配置包括：1/8、 1/4、1/2、3/4 和7/8 深度。`例如，如果接收FIFO 选择1/4，则在UART 接收到4 个数据时产生接收中断`。

>　　发送FIFO的基本工作过程： 只要有数据填充到发送FIFO 里，就会立即启动发送过程。由于发送本身是个相对缓慢的过程，因此在发送的同时其它需要发送的数据还可以继续填充到发送 FIFO 里。当发送 FIFO 被填满时就不能再继续填充了，否则会造成数据丢失，此时只能等待。这个等待并不会很久，以9600 的波特率为例，等待出现一个空位的时间在1ms 上下。发送 FIFO 会按照填入数据的先后顺序把数据一个个发送出去，直到发送 FIFO 全空时为止。已发送完毕的数据会被自动清除，在发送FIFO 里同时会多出一个空位。

>　　接收FIFO的基本工作过程： 当硬件逻辑接收到数据时，就会往接收FIFO 里填充接收到的数据。程序应当及时取走这些数据，数据被取走也是在接收FIFO 里被自动删除的过程，因此在接收 FIFO 里同时会多出一个空位。如果在接收 FIFO 里的数据未被及时取走而造成接收FIFO 已满，则以后再接收到数据时因无空位可以填充而造成数据丢失。

>　　收发FIFO 主要是为了`解决UART 收发中断过于频繁而导致CPU 效率不高`的问题而引入的。在进行 UART 通信时，中断方式比轮询方式要简便且效率高。但是，如果没有收发 FIFO，则每收发一个数据都要中断处理一次，效率仍然不够高。如果有了收发FIFO，则可以在连续收发若干个数据（可多至14 个）后才产生一次中断然后一并处理，这就大大提高了收发效率。

### UART的优势和缺点
- 优势：实现简单，成本低廉，适用于短距离通信。
- 局限性：传输速度相对较慢，不适合高速数据传输需求；没有内置的错误恢复机制，对噪声和干扰较为敏感




# GPIO
